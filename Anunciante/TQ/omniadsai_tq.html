<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OmniAdsAI_TQ</title>
  <link rel="icon" href="../../assets/TRKKN_icon.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Mulish', sans-serif;
      background: #fff;
      color: #000;
      padding: 20px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 720px;
    }
    .form-section {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .canvas-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    canvas {
      border: 1px solid #ccc;
    }
    fieldset.form-group {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 6px; /* Interlineado entre secciones */
    }
    legend {
      font-weight: bold;
      font-size: 1.1em;
      padding: 0 10px;
    }
    fieldset.form-group .form-section,
    fieldset.form-group > div.form-section {
      margin-bottom: 12px;
    }
    select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: 'Mulish', sans-serif;
      max-width: 260px;
      color: #000;
      background-color: #fff;
    } 
    .label-wrapper {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      min-width: 100%;
    }
    .label-wrapper label {
      min-width: 160px;
      text-align: right;
    }
    .label-wrapper select {
      flex: 1;
    }
    /* Sangr√≠a y alineaci√≥n para checkboxes en m√∫ltiples l√≠neas */
    .form-section label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      font-size: 15px;
    }
    .form-section label input[type="checkbox"] {
      margin-top: 2px;
      margin-right: 6px;
      flex-shrink: 0;
    }
    .form-section label span {
      display: inline;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .form-section.checkbox-opciones {
      margin-left: 24px;
    }
    .galeria-thumbs {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
      justify-content: flex-start;
      max-width: 100%;
      overflow-x: auto;
    }
    .thumbnail-preview {
      width: 60px;
      height: auto;
      border: 1px solid #ccc;
      cursor: pointer;
      transition: transform 0.2s;
      box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.1);
    }
    .thumbnail-preview:hover {
      transform: scale(1.05);
      border-color: #555;
    }
  </style>
  <script type="module" src="./js/auth.js"></script>
  <script type="module" src="./js/infoProduct.js"></script>
  <script type="module" src="./js/audienciaFactores.js"></script>
</head>
  
<body style="display:none">
  <h1><img src="logo_omniadsai_tq.png" alt="Cargando Logo TQ OmniAdsAI TRKKN..." style= "width: 500px; margin-left: 20px" /></h1>
  <form id="formulario"></form>
  <div class="canvas-wrapper" id="canvasContainer"></div>

  <script type="module">
    import { cargarJerarquia } from "./js/infoProduct.js";
    import { cargarAudienciaFactores } from "./js/audienciaFactores.js";
  
    document.addEventListener("DOMContentLoaded", async () => {
      await cargarJerarquia();
      await cargarAudienciaFactores();
      await cargarTamanosYCanvas();
    });
  </script>
  
  <script>
    async function cargarTamanosYCanvas() {
      const jsonPath = "../../Anunciante/TQ/json/";
      const canvasContainer = document.getElementById("canvasContainer");

      const tamanos = await fetch(`${jsonPath}tama√±os.json`).then(r => r.json());
      tamanos.forEach(t => {
        const wrapper = document.createElement("div");
        wrapper.style.display = "flex";
        wrapper.style.flexDirection = "column";
        wrapper.style.alignItems = "center";
        wrapper.style.marginBottom = "24px";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = `check_${t.id}`;
        checkbox.checked = true;
        checkbox.style.marginBottom = "8px";

        const label = document.createElement("label");
        label.setAttribute("for", checkbox.id);
        label.textContent = `üñºÔ∏è ${t.nombre}`;
        label.style.marginBottom = "8px";
        label.style.fontWeight = "bold";

        const canvas = document.createElement("canvas");
        canvas.id = `canvas_${t.id}`;
        canvas.width = t.ancho;
        canvas.height = t.alto;

        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        wrapper.appendChild(canvas);
        canvasContainer.appendChild(wrapper);
        
        const fabricCanvas = new fabric.Canvas(canvas.id, {
          backgroundColor: "#ffffff",
          selection: true
        });

        if (!window.canvasRefs) window.canvasRefs = {};
        window.canvasRefs[t.id] = {
          canvas: fabricCanvas,
          activo: checkbox.checked
        };

        checkbox.addEventListener("change", () => {
          window.canvasRefs[t.id].activo = checkbox.checked;
          canvas.style.opacity = checkbox.checked ? "1" : "0.3";
        });
      });
    }
  </script>
  
  <script type="module">
    import { mostrarGaleriaLogos, mostrarGaleriaIconos, agregarTexto, limpiarCanvas, agregarThumbnail } from "../../Anunciante/TQ/js/controlesCanvas.js";
  
    document.addEventListener("DOMContentLoaded", () => {
      const intervalo = setInterval(() => {
        if (window.canvasRefs) {
          clearInterval(intervalo);
  
          for (const [id, ref] of Object.entries(window.canvasRefs)) {
            const controls = document.createElement("div");
            controls.style.display = "flex";
            controls.style.gap = "10px";
            controls.style.marginTop = "10px";
            controls.style.marginBottom = "20px";
  
            const btnLogo = document.createElement("button");
            btnLogo.textContent = "‚ûïlogo";
            btnLogo.onclick = () => {
              mostrarGaleriaLogos(ref.canvas);
            };
  
            const btnIcono = document.createElement("button");
            btnIcono.textContent = "‚ûï√≠cono";
            btnIcono.onclick = () => {
              mostrarGaleriaIconos(ref.canvas);
            };
  
            const btnTexto = document.createElement("button");
            btnTexto.textContent = "üìùtexto";
            btnTexto.onclick = () => {
              agregarTexto(ref.canvas);
              setTimeout(() => agregarThumbnail(ref.canvas, ref.galeriaId), 200);
            };
  
            const btnLimpiar = document.createElement("button");
            btnLimpiar.textContent = "üßΩLimpiar";
            btnLimpiar.onclick = () => {
              limpiarCanvas(ref.canvas);
              setTimeout(() => agregarThumbnail(ref.canvas, ref.galeriaId), 200);
            };
  
            controls.appendChild(btnLogo);
            controls.appendChild(btnIcono);
            controls.appendChild(btnTexto);
            controls.appendChild(btnLimpiar);
  
            // Crear contenedor de miniaturas (galer√≠a)
            const galeria = document.createElement("div");
            galeria.className = "galeria-thumbs";
            galeria.id = `galeria_${id}`;
            ref.galeriaId = galeria.id; // Guarda el ID por si lo necesitas luego
  
            ref.canvas.wrapperEl.parentElement.appendChild(controls);
            // Insertar la galer√≠a en el DOM
            ref.canvas.wrapperEl.parentElement.appendChild(galeria);
          }
        }
      }, 200);
    });
  </script>

  <!-- Modal para elegir logo -->
  <div id="modalLogos" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:8px; max-width:90%; max-height:80%; overflow:auto;">
      <h3>Selecciona un logo</h3>
      <div id="galeriaLogos" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
      <button onclick="document.getElementById('modalLogos').style.display='none'" style="margin-top:10px;">Cerrar</button>
    </div>
  </div>

  <!-- Modal para elegir √≠cono -->
  <div id="modalIconos" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:8px; max-width:90%; max-height:80%; overflow:auto;">
      <h3>Selecciona un √≠cono</h3>
      <div id="galeriaIconos" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
      <button onclick="document.getElementById('modalIconos').style.display='none'" style="margin-top:10px;">Cerrar</button>
    </div>
  </div>

  <script type="module">
    import { generarCreatividadesConFondos } from "../../Anunciante/TQ/js/controlesCanvas.js";
  
    function obtenerValoresSeleccionados(name) {
      return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(el => el.value);
    }
    
    function obtenerFactorYOpciones() {
      const factores = {};
      const inputs = document.querySelectorAll('fieldset.form-group input[type="checkbox"]');
      inputs.forEach(input => {
        const nombre = input.name;
        if (!factores[nombre]) factores[nombre] = [];
        if (input.checked) factores[nombre].push(input.value);
      });
      return factores;
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      const btnGenerar = document.createElement("button");
      btnGenerar.textContent = "üöÄ Generar creatividades";
      btnGenerar.style.marginTop = "20px";
      btnGenerar.style.padding = "12px 20px";
      btnGenerar.style.fontSize = "16px";
      btnGenerar.style.fontWeight = "bold";
      btnGenerar.style.borderRadius = "8px";
      btnGenerar.style.backgroundColor = "#4CAF50";
      btnGenerar.style.color = "#fff";
      btnGenerar.style.border = "none";
      btnGenerar.style.cursor = "pointer";
    
      document.getElementById("formulario").insertAdjacentElement("afterend", btnGenerar); //Ubicaci√≥n del bot√≥n (din√°mico) de generaci√≥n al final del formulario.
    
      btnGenerar.onclick = () => {
        const audiencias = obtenerValoresSeleccionados("audiencia");
        const factores = obtenerFactorYOpciones();
        const productoSelect = document.getElementById("producto");
        const nombreProducto = productoSelect?.value || "producto";
    
        const canvasRefs = window.canvasRefs;
    
        let total = 0;
    
        audiencias.forEach(audId => {
          for (const factorId in factores) {
            factores[factorId].forEach(opcionId => {
              for (const tama√±oId in canvasRefs) {
                const ref = canvasRefs[tama√±oId];
                if (!ref.activo) continue;
    
                generarCreatividadesConFondos(
                  ref.canvas,
                  audId,
                  factorId,
                  opcionId,
                  tama√±oId,
                  nombreProducto,
                  (dataURL, nombreCreatividad) => {
                    // Mostrar en consola
                    console.log(`‚úÖ Generada: ${nombreCreatividad}`);
                    total++;
    
                    // Tambi√©n puedes mostrar miniatura si quieres aqu√≠
                    const thumb = document.createElement("img");
                    thumb.src = dataURL;
                    thumb.className = "thumbnail-preview";
                    document.getElementById(ref.galeriaId).appendChild(thumb);
                  }
                );
              }
            });
          }
        });
    
        setTimeout(() => {
          alert("üéâ Creatividades generadas correctamente.");
        }, 2000);
      };
    });
  </script>

</body>
</html>
