<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OmniAdsAI_TQ</title>
  <link rel="icon" href="../../assets/TRKKN_icon.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Mulish', sans-serif;
      background: #fff;
      color: #000;
      padding: 20px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 960px;
    }
    .form-section {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .canvas-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    canvas {
      border: 1px solid #ccc;
    }
    fieldset.form-group {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
    }
    legend {
      font-weight: bold;
      font-size: 1.1em;
      padding: 0 10px;
    }
    fieldset.form-group .form-section,
    fieldset.form-group > div.form-section {
      margin-bottom: 12px;
    }
    select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: 'Mulish', sans-serif;
      max-width: 260px;
      color: #000;
      background-color: #fff;
    }
  </style>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { firebaseConfig } from "../../firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth, user => {
      if (!user) {
        alert("üîí Inicia sesi√≥n Trkkie!");
        window.location.href = "../../auth.html";
      } else {
        console.log("‚úÖ Usuario autenticado:", user.email);
        document.body.style.display = "block";
      }
    });
  </script>
  
</head>
  
<body style="display:none">
  <h1><img src="Logo_TQ_OmniAdsAI_TRKKN.png" alt="Cargando Logo TQ OmniAdsAI TRKKN..." style= "width: 400px; margin-left: 20px" /></h1>
  <form id="formulario"></form>
  <div class="canvas-wrapper" id="canvasContainer"></div>
  <script>
    
    function crearPlaceholder(texto) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = texto;
      opt.disabled = true;
      opt.selected = true;
      return opt;
    }

    async function cargarJerarquia() {
      const jsonPath = "../../Anunciante/TQ/json/";
      const form = document.getElementById("formulario");

      const section = document.createElement("fieldset");
      section.className = "form-group";
      section.innerHTML = `<legend>üìã Informaci√≥n del producto</legend>`;
      form.appendChild(section);

      const [segmentos, negocios, productos, campa√±as] = await Promise.all([
        fetch(`${jsonPath}segmentos.json`).then(r => r.json()),
        fetch(`${jsonPath}negocios.json`).then(r => r.json()),
        fetch(`${jsonPath}productos.json`).then(r => r.json()),
        fetch(`${jsonPath}campa√±as.json`).then(r => r.json())
      ]);

      const selects = {
        segmento: { label: "üè≠ Segmento", opciones: segmentos },
        negocio: { label: "üß™ Negocio/Marca" },
        producto: { label: "üíä Producto" },
        campana: { label: "üì£ Campa√±a" }
      };

      const elements = {};

      for (const [id, data] of Object.entries(selects)) {
        const div = document.createElement("div");
        div.className = "form-section";

        const label = document.createElement("label");
        label.innerHTML = `<strong>${data.label}:</strong>`;

        const select = document.createElement("select");
        select.id = id;
        label.appendChild(select);
        div.appendChild(label);
        section.appendChild(div);
        elements[id] = select;

        const placeholderText = `Selecciona un ${data.label.split(' ')[1].toLowerCase()}`;
        select.appendChild(crearPlaceholder(placeholderText));

        if (data.opciones) {
          data.opciones.forEach(opt => {
            const option = document.createElement("option");
            option.value = opt.id;
            option.textContent = opt.nombre;
            select.appendChild(option);
          });
        }
      }

      // Descripci√≥n
      const descripcionSection = document.createElement("div");
      descripcionSection.className = "form-section";
      descripcionSection.innerHTML = `
        <label for="descripcion"><strong>üìù Descripci√≥n:</strong></label>
        <textarea id="descripcion" name="descripcion" rows="3" style="width: 100%;" placeholder="Escribe detalles clave sobre el producto, campa√±a, temporada, lenguaje, expresiones, etc."></textarea>`;
      section.appendChild(descripcionSection);

      // Cascadas
      elements.segmento.addEventListener("change", () => {
        const segID = elements.segmento.value;
        elements.negocio.innerHTML = "";
        elements.producto.innerHTML = "";
        elements.campana.innerHTML = "";

        elements.negocio.appendChild(crearPlaceholder("Selecciona un negocio/marca"));
        elements.producto.appendChild(crearPlaceholder("Selecciona un producto"));
        elements.campana.appendChild(crearPlaceholder("Selecciona una campa√±a"));

        if (negocios[segID]) {
          negocios[segID].forEach(n => {
            const opt = document.createElement("option");
            opt.value = n.id;
            opt.textContent = n.nombre;
            elements.negocio.appendChild(opt);
          });
        }
      });

      elements.negocio.addEventListener("change", () => {
        const segID = elements.segmento.value;
        const negID = elements.negocio.value;
        elements.producto.innerHTML = "";
        elements.campana.innerHTML = "";

        elements.producto.appendChild(crearPlaceholder("Selecciona un producto"));
        elements.campana.appendChild(crearPlaceholder("Selecciona una campa√±a"));

        if (productos[segID]?.[negID]) {
          productos[segID][negID].forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = p.nombre;
            elements.producto.appendChild(opt);
          });
        }
      });

      elements.producto.addEventListener("change", () => {
        const segID = elements.segmento.value;
        const negID = elements.negocio.value;
        const prodID = elements.producto.value;
        elements.campana.innerHTML = "";
        elements.campana.appendChild(crearPlaceholder("Selecciona una campa√±a"));

        if (campa√±as[segID]?.[negID]?.[prodID]) {
          campa√±as[segID][negID][prodID].forEach(c => {
            const opt = document.createElement("option");
            opt.value = c.id;
            opt.textContent = c.nombre;
            elements.campana.appendChild(opt);
          });
        }
      });
    }
    
    async function cargarAudienciaFactores() {
      const jsonPath = "../../Anunciante/TQ/json/";
      const form = document.getElementById("formulario");

      const section = document.createElement("fieldset");
      section.className = "form-group";
      section.innerHTML = `<legend>üåê Audiencia (Factores Contextuales)</legend>`;
      form.appendChild(section);

      const audiencias = await fetch(`${jsonPath}audiencias.json`).then(r => r.json());
      const divAud = document.createElement("div");
      divAud.className = "form-section";
      divAud.innerHTML = `<label><strong>üéØ Audiencia:</strong></label>`;

      audiencias.forEach(aud => {
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.name = "audiencia";
        checkbox.value = aud.id;

        const span = document.createElement("span");
        span.textContent = ` ${aud.emoji || ""} ${aud.nombre}`;

        const wrapper = document.createElement("label");
        wrapper.appendChild(checkbox);
        wrapper.appendChild(span);
        wrapper.style.marginRight = "16px";
        divAud.appendChild(wrapper);
      });
      section.appendChild(divAud);

      const factores = await fetch(`${jsonPath}factores.json`).then(r => r.json());
      factores.forEach(factor => {
        const div = document.createElement("div");
        div.className = "form-section";
        div.innerHTML = `<label><strong>${factor.emoji} ${factor.nombre}:</strong></label>`;

        if (factor.tipo === "checkbox") {
          factor.opciones.forEach(op => {
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.name = factor.id;
            checkbox.value = op.id;

            const span = document.createElement("span");
            span.textContent = `${op.emoji || ""} ${op.nombre}`;

            const wrapper = document.createElement("label");
            wrapper.appendChild(checkbox);
            wrapper.appendChild(span);
            wrapper.style.marginRight = "16px";

            div.appendChild(wrapper);
          });
        }
        section.appendChild(div);
      });
    }

    async function cargarTamanosYCanvas() {
      const jsonPath = "../../Anunciante/TQ/json/";
      const canvasContainer = document.getElementById("canvasContainer");

      const tamanos = await fetch(`${jsonPath}tama√±os.json`).then(r => r.json());
      tamanos.forEach(t => {
        const wrapper = document.createElement("div");
        wrapper.style.display = "flex";
        wrapper.style.flexDirection = "column";
        wrapper.style.alignItems = "center";
        wrapper.style.marginBottom = "24px";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = `check_${t.id}`;
        checkbox.checked = true;
        checkbox.style.marginBottom = "8px";

        const label = document.createElement("label");
        label.setAttribute("for", checkbox.id);
        label.textContent = `üñºÔ∏è ${t.nombre}`;
        label.style.marginBottom = "8px";
        label.style.fontWeight = "bold";

        const canvas = document.createElement("canvas");
        canvas.id = `canvas_${t.id}`;
        canvas.width = t.ancho;
        canvas.height = t.alto;

        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        wrapper.appendChild(canvas);
        canvasContainer.appendChild(wrapper);

        const fabricCanvas = new fabric.Canvas(canvas.id, {
          backgroundColor: "#ffffff",
          selection: true
        });

        if (!window.canvasRefs) window.canvasRefs = {};
        window.canvasRefs[t.id] = {
          canvas: fabricCanvas,
          activo: checkbox.checked
        };

        checkbox.addEventListener("change", () => {
          window.canvasRefs[t.id].activo = checkbox.checked;
          canvas.style.opacity = checkbox.checked ? "1" : "0.3";
        });
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await cargarJerarquia();
      await cargarAudienciaFactores();
      await cargarTamanosYCanvas();
    });
  </script>
</body>
</html>
