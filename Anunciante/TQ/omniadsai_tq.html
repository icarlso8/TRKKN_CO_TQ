<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Omni Ads AI - TQ</title>
  <link rel="icon" href="../../assets/TRKKN_icon.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/tweakpane@4.0.1/dist/tweakpane.min.umd.js"></script> se est√° usando Tweakpane como m√≥dulo UMD (.min.umd.js) pero tu script principal est√° definido como type="module", lo cual aisla el scope global y no expone Tweakpane directamente en window.-->
  <!-- ‚úÖ Usa esta l√≠nea -->
  <script src="https://cdn.jsdelivr.net/npm/tweakpane@3.1.8/dist/tweakpane.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Mulish', sans-serif;
      background: #fff;
      color: #000;
      padding: 20px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 960px;
    }
    .form-section {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .canvas-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    canvas {
      border: 1px solid #ccc;
    }
    fieldset.form-group {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
    }
    legend {
      font-weight: bold;
      font-size: 1.1em;
      padding: 0 10px;
    }
    .layout-container {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }
    
    .left-panel {
      flex: 1;
    }
    
    .right-panel {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
    }
    .right-panel > div {
      flex: 1 1 300px;
    }
    .canvas-group {
      border: 1px dashed #ccc;
      padding: 12px;
      border-radius: 8px;
      background: #fafafa;
      width: 100%;
    }
    .canvas-group h3 {
      margin-top: 0;
    }
    .canvas-list {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }
  </style>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { firebaseConfig } from "../../firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth, user => {
      if (!user) {
        alert("üîí Inicia sesi√≥n Trkkie!");
        window.location.href = "../../auth.html";
      } else {
        console.log("‚úÖ Usuario autenticado:", user.email);
        document.body.style.display = "block";
      }
    });

    window.initTweakpane = async function (canvasID) {
      const contenedor = document.getElementById(`panel_${canvasID}`);
      if (!contenedor) return;
    
      const pane = new Tweakpane.Pane({ title: `üéõÔ∏è Opciones ${canvasID}` });
      contenedor.appendChild(pane.element);
    
      const [logos, iconos, copies] = await Promise.all([
        fetch("json/logos.json").then(r => r.json()),
        fetch("json/iconos.json").then(r => r.json()),
        fetch("json/copies.json").then(r => r.json())
      ]);
    
      // LOGOS
      pane.addBlade({
        view: 'list',
        label: 'ü™™ Logo',
        options: logos.map(l => ({ text: l.nombre, value: l.id }))
      }).on('change', ev => {
        const selected = logos.find(l => l.id === ev.value);
        if (selected) agregarElementoAlCanvas(selected, 'logo', canvasID);
      });
    
      // ICONOS
      pane.addBlade({
        view: 'list',
        label: 'üîò Icono',
        options: iconos.map(i => ({ text: i.nombre, value: i.id }))
      }).on('change', ev => {
        const selected = iconos.find(i => i.id === ev.value);
        if (selected) agregarElementoAlCanvas(selected, 'icono', canvasID);
      });
    
      // COPIES
      pane.addBlade({
        view: 'list',
        label: '‚úçÔ∏è Copy',
        options: copies.map(c => ({ text: c.texto.slice(0, 40), value: c.id }))
      }).on('change', ev => {
        const selected = copies.find(c => c.id === ev.value);
        if (selected) agregarTextoAlCanvas(selected, canvasID);
      });
    
      // COPY PERSONALIZADO
      pane.addBlade({
        view: 'text',
        label: 'üÜï Copy libre',
        value: ''
      }).on('change', ev => {
        if (ev.value.trim()) {
          agregarTextoAlCanvas({ texto: ev.value }, canvasID);
        }
      });
    };

  </script>
</head>
  
<body style="display:none">
  <!-- <h1>üß™ Omni Ads AI - TQ</h1> -->
  <h1><img src="Logo_TQ_Omni_Ads_AI_OMG.png" alt="Logo Omni Ads AI TQ..." style= "width: 600px; margin-left: 20px" /></h1>

  <div class="layout-container">
    <div class="left-panel">
      <form id="formulario">
        <!-- Aqu√≠ ir√°n las secciones cargadas desde los JSON din√°micamente -->
      </form>
    </div>
    <div class="right-panel" id="canvasContainer">
      <!-- Aqu√≠ se insertar√°n los canvas -->
    </div>
  </div>
  
  <script>
    // Aqu√≠ cargaremos los JSON y generaremos el formulario
    // + render de canvas por tama√±o
    // + integraci√≥n con Tweakpane y fabric.js
    // Este bloque lo completar√© en el siguiente paso
    async function cargarJerarquia() {
      const jsonPath = "../../Anunciante/TQ/json/";
      const form = document.getElementById("formulario");
      
      const sectionJerarquia = document.createElement("fieldset");
      sectionJerarquia.className = "form-group";
      const legendJerarquia = document.createElement("legend");
      legendJerarquia.innerHTML = "üìã Informaci√≥n de la campa√±a";
      sectionJerarquia.appendChild(legendJerarquia);
      form.appendChild(sectionJerarquia);

      const segmentos = await fetch(`${jsonPath}segmentos.json`).then(r => r.json());
      const negocios = await fetch(`${jsonPath}negocios.json`).then(r => r.json());
      const productos = await fetch(`${jsonPath}productos.json`).then(r => r.json());
      const campa√±as = await fetch(`${jsonPath}campa√±as.json`).then(r => r.json());
  
      // ========== SEGMENTO ==========
      const segmentoSection = document.createElement("div");
      segmentoSection.className = "form-section";
      const segmentoLabel = document.createElement("label");
      segmentoLabel.innerHTML = "<strong>üè≠ Segmento:</strong>";
      const segmentoSelect = document.createElement("select");
      segmentoSelect.id = "segmento";
      segmentoLabel.appendChild(segmentoSelect);
      segmentoSection.appendChild(segmentoLabel);
      sectionJerarquia.appendChild(segmentoSection);
  
      segmentos.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = s.nombre;
        segmentoSelect.appendChild(opt);
      });
  
      // ========== NEGOCIO ==========
      const negocioSection = document.createElement("div");
      negocioSection.className = "form-section";
      const negocioLabel = document.createElement("label");
      negocioLabel.innerHTML = "<strong>üß™ Negocio/Marca:</strong>";
      const negocioSelect = document.createElement("select");
      negocioSelect.id = "negocio";
      negocioLabel.appendChild(negocioSelect);
      negocioSection.appendChild(negocioLabel);
      sectionJerarquia.appendChild(negocioSection);
  
      // ========== PRODUCTO ==========
      const productoSection = document.createElement("div");
      productoSection.className = "form-section";
      const productoLabel = document.createElement("label");
      productoLabel.innerHTML = "<strong>üíä Producto:</strong>";
      const productoSelect = document.createElement("select");
      productoSelect.id = "producto";
      productoLabel.appendChild(productoSelect);
      productoSection.appendChild(productoLabel);
      sectionJerarquia.appendChild(productoSection);
  
      // ========== CAMPA√ëA ==========
      const campanaSection = document.createElement("div");
      campanaSection.className = "form-section";
      const campanaLabel = document.createElement("label");
      campanaLabel.innerHTML = "<strong>üì£ Campa√±a:</strong>";
      const campanaSelect = document.createElement("select");
      campanaSelect.id = "campana";
      campanaLabel.appendChild(campanaSelect);
      campanaSection.appendChild(campanaLabel);
      sectionJerarquia.appendChild(campanaSection);

      // ========== DESCRIPCI√ìN ==========
      const descripcionSection = document.createElement("div");
      descripcionSection.className = "form-section";
      
      const descripcionLabel = document.createElement("label");
      descripcionLabel.setAttribute("for", "descripcion");
      descripcionLabel.innerHTML = "<strong>üìù Descripci√≥n:</strong>";
      
      const descripcionInput = document.createElement("textarea");
      descripcionInput.id = "descripcion";
      descripcionInput.name = "descripcion";
      descripcionInput.rows = 3;
      descripcionInput.style.width = "100%";
      descripcionInput.placeholder = "Escribe detalles clave sobre el producto, campa√±a, temporada, lenguaje, expresiones, etc.";
      
      descripcionSection.appendChild(descripcionLabel);
      descripcionSection.appendChild(descripcionInput);
      sectionJerarquia.appendChild(descripcionSection);

      // Eventos en cascada
      segmentoSelect.addEventListener("change", () => {
        const segID = segmentoSelect.value;
        negocioSelect.innerHTML = "";
        productoSelect.innerHTML = "";
        campanaSelect.innerHTML = "";
  
        if (negocios[segID]) {
          negocios[segID].forEach(n => {
            const opt = document.createElement("option");
            opt.value = n.id;
            opt.textContent = n.nombre;
            negocioSelect.appendChild(opt);
          });
          negocioSelect.dispatchEvent(new Event("change"));
        }
      });
  
      negocioSelect.addEventListener("change", () => {
        const segID = segmentoSelect.value;
        const negID = negocioSelect.value;
        productoSelect.innerHTML = "";
        campanaSelect.innerHTML = "";
  
        if (productos[segID] && productos[segID][negID]) {
          productos[segID][negID].forEach(p => {
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = p.nombre;
            productoSelect.appendChild(opt);
          });
          productoSelect.dispatchEvent(new Event("change"));
        }
      });
  
      productoSelect.addEventListener("change", () => {
        const segID = segmentoSelect.value;
        const negID = negocioSelect.value;
        const prodID = productoSelect.value;
        campanaSelect.innerHTML = "";
  
        if (campa√±as[segID] && campa√±as[segID][negID] && campa√±as[segID][negID][prodID]) {
          campa√±as[segID][negID][prodID].forEach(c => {
            const opt = document.createElement("option");
            opt.value = c.id;
            opt.textContent = c.nombre;
            campanaSelect.appendChild(opt);
          });
        }
      });
  
      segmentoSelect.dispatchEvent(new Event("change"));
    }

    async function cargarAudienciaFactores() {
      const jsonPath = "../../Anunciante/TQ/json/";
      const form = document.getElementById("formulario");
    
      const sectionContexto = document.createElement("fieldset");
      sectionContexto.className = "form-group";
      const legend = document.createElement("legend");
      legend.innerHTML = "üåê Audiencia (Factores Contextuales)";
      sectionContexto.appendChild(legend);
      form.appendChild(sectionContexto);
    
      // üîπ AUDIENCIAS
      const audiencias = await fetch(`${jsonPath}audiencias.json`).then(r => r.json());
      const audienciaSection = document.createElement("div");
      audienciaSection.className = "form-section";
    
      const audienciaLabel = document.createElement("label");
      audienciaLabel.innerHTML = "<strong>üéØ Audiencia:</strong>";
      audienciaSection.appendChild(audienciaLabel);
    
      audiencias.forEach(aud => {
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.name = "audiencia";
        checkbox.value = aud.id;
    
        const span = document.createElement("span");
        span.textContent = ` ${aud.emoji || ""} ${aud.nombre}`;
    
        const wrapper = document.createElement("label");
        wrapper.appendChild(checkbox);
        wrapper.appendChild(span);
        wrapper.style.marginRight = "16px";
    
        audienciaSection.appendChild(wrapper);
      });
    
      sectionContexto.appendChild(audienciaSection);
    
      // üîπ FACTORES CONTEXTUALES
      const factores = await fetch(`${jsonPath}factores.json`).then(r => r.json());
    
      factores.forEach(factor => {
        const section = document.createElement("div");
        section.className = "form-section";
    
        const label = document.createElement("label");
        label.innerHTML = `<strong>${factor.emoji} ${factor.nombre}:</strong>`;
        section.appendChild(label);
    
        if (factor.tipo === "checkbox") {
          factor.opciones.forEach(op => {
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.name = factor.id;
            checkbox.value = op.id;
    
            const span = document.createElement("span");
            span.textContent = `${op.emoji || ""} ${op.nombre}`;
    
            const wrapper = document.createElement("label");
            wrapper.appendChild(checkbox);
            wrapper.appendChild(span);
            wrapper.style.marginRight = "16px";
    
            section.appendChild(wrapper);
          });
        }
    
        sectionContexto.appendChild(section);
      });
    }

    async function cargarTamanosYCanvas() {
      const jsonPath = "../../Anunciante/TQ/json/";
      const canvasContainer = document.getElementById("canvasContainer");
    
      const tamanos = await fetch(`${jsonPath}tama√±os.json`).then(r => r.json());
    
      tamanos.forEach(t => {
        const wrapper = document.createElement("div");
        wrapper.style.display = "flex";
        wrapper.style.flexDirection = "column";
        wrapper.style.alignItems = "center";
        wrapper.style.marginBottom = "24px";
    
        // Checkbox para activar el tama√±o
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = `check_${t.id}`;
        checkbox.checked = true;
        checkbox.style.marginBottom = "8px";
    
        const label = document.createElement("label");
        label.setAttribute("for", checkbox.id);
        label.textContent = `üñºÔ∏è ${t.nombre}`;
        label.style.marginBottom = "8px";
        label.style.fontWeight = "bold";
    
        const canvas = document.createElement("canvas");
        canvas.id = `canvas_${t.id}`;
        canvas.width = t.ancho;
        canvas.height = t.alto;
    
        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        wrapper.appendChild(canvas);

        // ‚úÖ Aqu√≠ agregamos el contenedor para Tweakpane
        const panelDiv = document.createElement("div");
        panelDiv.id = `panel_${t.id}`;
        panelDiv.style.marginTop = "12px";
        panelDiv.style.borderTop = "1px dashed #ccc";
        panelDiv.style.paddingTop = "12px";
        wrapper.appendChild(panelDiv);
        
        // ‚è¨ Esta l√≠nea se mantiene
        canvasContainer.appendChild(wrapper);

        // ‚úÖ Finalmente, inicializa Tweakpane
        window.initTweakpane(t.id);
    
        const fabricCanvas = new fabric.Canvas(canvas.id, {
          backgroundColor: "#ffffff",
          selection: true
        });
    
        if (!window.canvasRefs) window.canvasRefs = {};
        window.canvasRefs[t.id] = {
          canvas: fabricCanvas,
          activo: checkbox.checked
        };
    
        checkbox.addEventListener("change", () => {
          window.canvasRefs[t.id].activo = checkbox.checked;
          canvas.style.opacity = checkbox.checked ? "1" : "0.3";
        });
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await cargarJerarquia();
      await cargarAudienciaFactores();
      await cargarTamanosYCanvas();
});

    function agregarElementoAlCanvas(item, tipo, canvasID) {
      const canvas = window.canvasRefs[canvasID].canvas;
      fabric.Image.fromURL(`Anunciante/TQ/assets/${tipo === 'logo' ? 'logos' : 'iconos'}/${item.archivo}`, img => {
        img.set({
          left: 50,
          top: 50,
          scaleX: 0.3,
          scaleY: 0.3,
          selectable: true,
          hasControls: true
        });
        canvas.add(img);
      });
    }
    
    function agregarTextoAlCanvas(copy, canvasID) {
      const canvas = window.canvasRefs[canvasID].canvas;
      const text = new fabric.Textbox(copy.texto, {
        left: 50,
        top: 50,
        fontSize: 18,
        fill: '#000',
        fontFamily: 'Mulish',
        selectable: true
      });
      canvas.add(text);
    }

  </script>
</body>
</html>
